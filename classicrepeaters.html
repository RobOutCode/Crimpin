<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Classic 7/3 Repeaters</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .section-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .details-marker::marker {
            color: #14b8a6;
        }
        .timer-circle {
            transition: stroke-dashoffset 1s linear;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="max-w-4xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center mb-4">
            <div id="user-info-display" class="text-slate-700 font-medium hidden">
                Welcome, <span id="user-name-placeholder" class="text-teal-600">Guest</span>!
            </div>
            <div class="flex space-x-2">
                <!-- Corrected href to reg.html -->
                <a href="reg.html" id="register-login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">Register / Log In</a>
                <button type="button" id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 hidden">Log Out</button>
            </div>
        </div>
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-900">Interactive Classic 7/3 Repeaters</h1>
            <p class="mt-4 text-lg text-slate-600">Your guided session for strength-endurance and anaerobic capacity.</p>
        </header>

        <main class="space-y-10">

            <section id="setup" class="section-card p-6 md:p-8">
                <h2 class="text-2xl font-bold text-slate-900 mb-4">Before You Start</h2>
                <div class="space-y-6">
                    <article>
                        <h3 class="text-lg font-semibold text-teal-600 mb-2">‚ö†Ô∏è Safety Disclaimer</h3>
                        <ul class="list-disc list-inside space-y-1 text-slate-600">
                            <li>A thorough warm-up is crucial. Do not skip this phase.</li>
                            <li>Listen to your body. Stop immediately if you feel sharp pain. Soreness is normal, pain is not.</li>
                            <li>Consult a professional if you have pre-existing injuries or concerns.</li>
                        </ul>
                    </article>
                    <article>
                        <h3 class="text-lg font-semibold text-teal-600 mb-2">üõ†Ô∏è Required Equipment</h3>
                           <ul class="list-disc list-inside space-y-1 text-slate-600">
                            <li>Fingerboard / Hangboard (or Tension Block)</li>
                            <li>Loading Pin & Weights (if needed)</li>
                            <li>Timer (this app will handle it!)</li>
                            <li>Notebook/App to log progress (recommended)</li>
                        </ul>
                    </article>
                </div>
            </section>

            <section id="warmup" class="section-card">
                <details class="p-6 md:p-8">
                    <summary class="text-2xl font-bold text-slate-900 cursor-pointer details-marker">Phase 1: Dynamic Warm-up (15-20 min)</summary>
                    <div class="mt-6 border-t border-slate-200 pt-6 space-y-4 text-slate-600">
                        <p>This phase gradually prepares your body for intense work. Complete all steps.</p>
                        <ul class="list-decimal list-inside space-y-2">
                            <li><strong>General Cardio (5 min):</strong> Light jog, jumping jacks, or cycling.</li>
                            <li><strong>Dynamic Stretches & Mobility (5-7 min):</strong> Arm circles, shoulder rolls, wrist circles, and finger extensions.</li>
                            <li><strong>Light Hangs/Pulls (5-8 min):</strong> Perform light, low-intensity hangs or pulls with various grips. This includes 2-3 ramp-up sets, gradually increasing weight to 80% of your estimated working weight.</li>
                        </ul>
                    </div>
                    <!-- Removed misplaced </article> tag -->
                </details>
            </section>
            
            <section id="weight-test" class="section-card p-6 md:p-8">
                <h2 class="text-2xl font-bold text-slate-900 mb-2">Phase 2: Determine Your Training Weight (7/3 Repeater Test)</h2>
                <p class="mb-6 text-slate-600">Find a weight that allows you to complete all 6 repetitions of a 7s ON / 3s OFF cycle with good form, but where the last 1-2 reps feel very challenging and close to failure. Rest 2-5 minutes between test attempts.</p>
                <div class="bg-slate-100 p-6 rounded-lg">
                    <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                        <div>
                             <label for="grip-test-type" class="block text-sm font-medium text-slate-700">Grip Type</label>
                           <input type="text" id="grip-test-type" value="20mm Half-Crimp" class="mt-1 block w-full sm:w-48 rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                        </div>
                        <div>
                            <label for="test-weight" class="block text-sm font-medium text-slate-700">Test Weight (lbs/kg)</label>
                            <input type="number" id="test-weight" value="40" class="mt-1 block w-full sm:w-32 rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                        </div>
                        <button type="button" id="start-test-btn" class="w-full sm:w-auto bg-teal-500 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-600 transition duration-300">Start 6-Rep Test Cycle</button>
                    </div>
                    <div id="test-timer-display" class="mt-4 text-center text-3xl font-bold text-slate-700 h-10"></div>
                     <div class="mt-4 text-center">
                        <button type="button" id="save-weight-btn" class="w-full sm:w-auto bg-slate-600 text-white font-bold py-2 px-6 rounded-md hover:bg-slate-700 transition duration-300 disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>Save Weight for Workout</button>
                    </div>
                </div>
            </section>

            <section id="main-workout" class="section-card p-6 md:p-8">
                <h2 class="text-2xl font-bold text-slate-900 mb-2">Phase 3: Classic 7/3 Repeaters</h2>
                <p class="mb-4 text-slate-600">This protocol enhances strength-endurance and anaerobic capacity with a 7s ON / 3s OFF cycle.</p>
                <ul class="list-disc list-inside text-slate-600 mb-6 space-y-1">
                    <li><strong>Sets per Grip:</strong> Perform 1 to 3 sets per chosen grip type. One set includes 6 reps for both hands (e.g., Right Hand Reps 1-6, then Left Hand Reps 1-6).</li>
                    <li><strong>Hold/Rest Cycle:</strong> 7 seconds ON (hold), 3 seconds OFF (rest) between reps.</li>
                    <li><strong>Rest Between Sets:</strong> Take a 2-5 minute rest AFTER both hands have completed all 6 reps for a set.</li>
                </ul>
                
                <div id="workout-setup" class="bg-slate-100 p-6 rounded-lg space-y-4">
                    <div>
                        <label for="workout-grip-type" class="block text-sm font-medium text-slate-700">Grip Type for this Workout</label>
                        <input type="text" id="workout-grip-type" value="20mm Half-Crimp" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                    </div>
                    <div class="flex flex-col sm:flex-row justify-between gap-4">
                         <div class="flex-1">
                            <label for="workout-weight" class="block text-sm font-medium text-slate-700">Training Weight (lbs/kg)</label>
                            <input type="number" id="workout-weight" value="40" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                        </div>
                         <div class="flex-1">
                            <label for="sets-per-grip-input" class="block text-sm font-medium text-slate-700">Total Sets (1-3, each set includes both hands)</label>
                            <input type="number" id="sets-per-grip-input" value="1" min="1" max="3" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                        </div>
                    </div>
                    <button type="button" id="start-workout-btn" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-md hover:bg-red-700 transition duration-300 text-lg">Start Workout</button>
                </div>

                <div id="workout-engine" class="hidden text-center mt-6">
                    <div class="relative w-48 h-48 mx-auto mb-4">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="text-slate-200" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                            <circle id="timer-progress-ring" class="text-teal-500 timer-circle" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" stroke-linecap="round" transform="rotate(-90 50 50)" style="stroke-dasharray: 283; stroke-dashoffset: 283;"></circle>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <div id="timer-status" class="text-3xl font-bold text-slate-900">HOLD!</div>
                            <div id="timer-countdown" class="text-5xl font-bold text-slate-700">7</div>
                        </div>
                    </div>
                    <div id="current-set-display" class="text-xl font-bold text-slate-800 mb-2">Set 1 of 1</div>
                    <div id="current-hand-display" class="text-lg font-semibold text-slate-600">Right Hand - Rep 1 of 6</div>
                    <div id="set-info" class="mt-2 text-md text-slate-500"></div>
                    <div id="total-times-display" class="mt-4 text-base text-slate-700 hidden">
                        <p>Total Workout Time: <span id="total-workout-time">0m 0s</span></p>
                        <p>Total Hold Time: <span id="total-lift-time">0m 0s</span></p>
                        <p>Total Rest Time: <span id="total-rest-time">0m 0s</span></p>
                    </div>
                     <div id="set-actions" class="mt-6 hidden flex flex-col sm:flex-row justify-center gap-4">
                        <button type="button" id="start-new-workout-btn" class="bg-slate-600 text-white font-bold py-2 px-6 rounded-md hover:bg-slate-700 transition duration-300">Start New Workout</button>
                    </div>
                    <button type="button" id="cancel-workout-btn" class="mt-6 w-full sm:w-auto bg-gray-500 text-white font-bold py-2 px-6 rounded-md hover:bg-gray-600 transition duration-300">Cancel Workout</button>
                </div>
                <div id="up-next-display" class="mt-6 text-center text-lg font-semibold text-slate-700 hidden">
                    Up Next: <span id="up-next-text"></span>
                </div>
            </section>
            
            <section id="current-session-lifts" class="section-card p-6 md:p-8">
                <h2 class="text-2xl font-bold text-slate-900 mb-4">Current Session Lifts</h2>
                <div id="results-table-container" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Grip Type</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Hand</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Set #</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Hold #</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Hold Duration (s)</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Weight (lbs/kg)</th>
                            </tr>
                        </thead>
                        <tbody id="current-session-table-body" class="bg-white divide-y divide-slate-200">
                            <tr>
                                <td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 text-center">No lifts logged in current session.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="workout-history" class="section-card p-6 md:p-8">
                <h2 class="text-2xl font-bold text-slate-900 mb-4">Past Workout History</h2>
                <div id="history-table-container" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Grip</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Weight</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Sets per Grip</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Hold Dur.</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Total Workout Time</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Total Hold Time</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Total Rest Time</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="bg-white divide-y divide-slate-200">
                            <tr>
                                <td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 text-center">Loading workout history...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="cooldown" class="section-card">
                 <details class="p-6 md:p-8">
                    <summary class="text-2xl font-bold text-slate-900 cursor-pointer details-marker">Phase 4: Cool-down (5-10 min)</summary>
                    <div class="mt-6 border-t border-slate-200 pt-6 space-y-4 text-slate-600">
                        <p>Helps transition your body to a state of recovery.</p>
                        <ul class="list-decimal list-inside space-y-2">
                           <li><strong>General Shaking:</strong> Shake out hands and arms to release tension.</li>
                           <li><strong>Static Stretches (20-30s each):</strong> Gently stretch forearm flexors and extensors, wrists, and fingers.</li>
                        </ul>
                    </div>
                </details>
            </section>

        </main>
    </div>

    <script>
        // This is the 'appId' field from your firebaseConfig, used by your existing code
        const __app_id = "1:1069153831535:web:b5275caff1a948aa831b9a";

        // This is your full Firebase project configuration object, stringified for your existing code
        const __firebase_config = JSON.stringify({
          apiKey: "AIzaSyChVyJ-FU_q2ecKum3kVj8ptV-Z0_jGIgY",
          authDomain: "crimptheory.firebaseapp.com",
          projectId: "crimptheory",
          storageBucket: "crimptheory.appspot.com",
          messagingSenderId: "1069153831535",
          appId: "1:1069153831535:web:b5275caff1a948aa831b9a",
          measurementId: "G-8DGM79J607"
        });
    </script>

    <script type="module">
        console.clear(); // Clear console on every load for clean debugging

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // State object (should be accessible globally by functions within this module)
        const state = {
            // Firebase
            db: null,
            auth: null,
            userId: 'anonymous', // Default to anonymous

            // Test Phase State
            testWeight: 40,
            testTimerId: null,
            testSeconds: 0, 
            testRepCounter: 1, // Current rep for the 6-rep test cycle
            testPhaseActive: false,
            testHoldDuration: 7, // Fixed 7s for test holds
            testRestDuration: 3, // Fixed 3s for test rests

            // Workout Protocol 4 Specific State
            workoutGripType: '20mm Half-Crimp',
            workoutWeight: 40,
            workoutTimerId: null,
            
            // Protocol 4 parameters
            holdDuration: 7,           // Fixed 7 seconds ON
            restBetweenReps: 3,        // Fixed 3 seconds OFF between reps
            longRestDuration: 180,     // Fixed 3 minutes (within 2-5 min range) after both hands complete a set

            currentRep: 1,             // Current repetition within a 6-rep cycle (1-6)
            repsPerCycle: 6,           // Fixed 6 repetitions per hand cycle

            currentSet: 1,             // Current overall set (a "set" now means both hands complete their reps)
            setsPerGrip: 1,            // User input: how many complete (Right Hand + Left Hand) sets for this grip

            currentHandIndex: 0,       // 0 for Right, 1 for Left
            hands: ['Right', 'Left'],
            
            countdown: 0,              // Current timer countdown value
            currentWorkoutPhase: 'setup', // 'setup', 'hold', 'rest-short', 'long-rest', 'completed'

            // Time Tracking
            workoutStartTime: null,
            totalWorkoutDuration: 0, 
            totalLiftDuration: 0,   
            totalRestDuration: 0,   

            // Data Storage
            currentSessionLifts: [], 
            workoutHistorySummaries: [] 
        };

        // DOM element references (will be assigned later inside DOMContentLoaded)
        let startTestBtn, testTimerDisplay, testWeightInput, gripTestTypeInput, saveWeightBtn;
        let workoutGripTypeInput, workoutWeightInput, setsPerGripInput, startWorkoutBtn, cancelWorkoutBtn, startNewWorkoutBtn;
        let workoutSetupDiv, workoutEngineDiv, timerStatus, timerCountdown, currentSetDisplay, currentHandDisplay, setInfo, progressRing;
        let currentSessionTableBody, historyTableBody;
        let upNextDisplay, upNextText, setActionsDiv, totalTimesDisplay, totalWorkoutTimeSpan, totalLiftTimeSpan, totalRestTimeSpan;
        let userNamePlaceholder, userInfoDisplay, registerLoginBtn, logoutBtn;

        const ringCircumference = 2 * Math.PI * 45;  

        // --- Utility Functions (defined globally in module scope) ---
        function updateRing(percent) {
            const offset = ringCircumference - (percent / 100) * ringCircumference;
            progressRing.style.strokeDashoffset = offset;
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}m ${remainingSeconds}s`;
        }

        function logLiftResult() {
            const now = new Date();
            const formattedDate = now.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            
            const newEntry = {
                date: now.toISOString(), // Changed to ISO string for better sorting and precision
                gripType: state.workoutGripType,
                hand: state.hands[state.currentHandIndex], 
                weight: state.workoutWeight,
                setNumber: state.currentSet,
                repNumber: state.currentRep, // Log the specific rep number within the cycle
                holdDuration: state.holdDuration 
            };
            state.currentSessionLifts.push(newEntry);
            renderCurrentSessionLifts();
        }

        function renderCurrentSessionLifts() {
            currentSessionTableBody.innerHTML = '';  
            if (state.currentSessionLifts.length === 0) {
                currentSessionTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 text-center">No lifts logged in current session.</td>
                    </tr>
                `;
                return;
            }
            state.currentSessionLifts.forEach(result => {
                const row = currentSessionTableBody.insertRow();
                row.className = 'hover:bg-slate-50';
                const workoutDate = new Date(result.date);
                const formattedDate = workoutDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) + ' ' + workoutDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${formattedDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${result.gripType}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${result.hand}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${result.setNumber}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${result.repNumber}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${result.holdDuration}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${result.weight}</td>
                `;
            });
        }

        function updateUpNextDisplay() {
            upNextDisplay.classList.remove('hidden');
            let nextText = '';

            switch (state.currentWorkoutPhase) {
                case 'hold':
                    // If it's the last rep for the current hand
                    if (state.currentRep === state.repsPerCycle) {
                        if (state.currentHandIndex === 0) { // Right hand finishing
                            nextText = `Next: Set ${state.currentSet}: ${state.hands[1]} Hand (Rep 1)`; // No long rest, switch hand immediately
                        } else { // Left hand finishing
                            if (state.currentSet < state.setsPerGrip) {
                                nextText = `Next: LONG REST (3m), then Set ${state.currentSet + 1}: ${state.hands[0]} Hand (Rep 1)`;
                            } else {
                                nextText = "Workout will be complete!";
                            }
                        }
                    } else { // Not the last rep, so next is a short rest
                        nextText = `Next: REST (3s) - Rep ${state.currentRep} of ${state.repsPerCycle} finished`;
                    }
                    break;
                case 'rest-short':
                    nextText = `Next: HOLD! (7s) - Rep ${state.currentRep} of ${state.repsPerCycle} on ${state.hands[state.currentHandIndex]} Hand`;
                    break;
                case 'long-rest':
                    nextText = `Next: HOLD! (7s) - Set ${state.currentSet}: ${state.hands[0]} Hand (Rep 1)`;
                    break;
                case 'setup':
                    nextText = "Ready to start the first HOLD!";
                    break;
                case 'completed':
                    nextText = "Workout complete!";
                    break;
                default:
                    nextText = "";
            }
            upNextText.textContent = nextText;
        }

        async function showWorkoutComplete() {
            clearInterval(state.workoutTimerId);
            state.currentWorkoutPhase = 'completed';

            state.totalWorkoutDuration = (Date.now() - state.workoutStartTime) / 1000;

            timerStatus.textContent = "Workout Complete!";
            timerCountdown.textContent = "üéâ";
            updateRing(100);
            currentHandDisplay.textContent = `All ${state.setsPerGrip} Sets Completed!`;
            setInfo.textContent = ""; 
            upNextDisplay.classList.add('hidden');
            
            totalWorkoutTimeSpan.textContent = formatTime(state.totalWorkoutDuration);
            totalLiftTimeSpan.textContent = formatTime(state.totalLiftDuration);
            totalRestTimeSpan.textContent = formatTime(state.totalRestDuration);
            totalTimesDisplay.classList.remove('hidden'); // Show total times

            setActionsDiv.classList.remove('hidden');
            cancelWorkoutBtn.classList.add('hidden');

            if (state.db && state.userId !== 'anonymous') {
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Define appId locally
                    const workoutSummary = {
                        date: new Date().toISOString(),
                        gripType: state.workoutGripType,
                        weight: state.workoutWeight,
                        setsPerGrip: state.setsPerGrip,
                        holdDuration: state.holdDuration, 
                        totalLiftDuration: state.totalLiftDuration,
                        totalRestDuration: state.totalRestDuration,
                        totalWorkoutDuration: state.totalWorkoutDuration,
                        userId: state.userId 
                    };
                    const workoutsCollectionRef = collection(state.db, `artifacts/${appId}/users/${state.userId}/classic_7_3_repeater_workout_summaries`); 
                    await addDoc(workoutsCollectionRef, workoutSummary);
                    console.log("Workout summary saved successfully!");
                    loadWorkoutHistory(); 
                } catch (e) {
                    console.error("Error saving workout summary:", e);
                }
            } else {
                console.warn("Skipping workout summary save: Firebase not initialized or user not authenticated.");
            }
        }

        function resetWorkoutForNewSession() {
            console.log("resetWorkoutForNewSession: Resetting workout for a new session.");
            clearInterval(state.workoutTimerId);
            state.currentSet = 1;
            state.currentRep = 1;
            state.currentHandIndex = 0;
            state.currentWorkoutPhase = 'setup'; 
            state.currentSessionLifts = [];
            state.totalLiftDuration = 0;
            state.totalRestDuration = 0;
            state.workoutStartTime = null;

            workoutSetupDiv.classList.remove('hidden');
            workoutEngineDiv.classList.add('hidden'); // Ensure engine is hidden
            updateRing(0);
            timerStatus.textContent = "HOLD!"; 
            timerCountdown.textContent = state.holdDuration; 
            setActionsDiv.classList.add('hidden');
            cancelWorkoutBtn.classList.remove('hidden'); // Ensure cancel button is visible when in setup mode
            totalTimesDisplay.classList.add('hidden'); // Hide total times

            renderCurrentSessionLifts();
            updateUpNextDisplay();
        }

        // --- Firestore Loading and Display of Workout History ---
        async function loadWorkoutHistory() {
            console.log("loadWorkoutHistory: Attempting to load workout history.");
            if (!state.db || !state.userId || state.userId === 'anonymous') { 
                console.warn("loadWorkoutHistory: Firebase not ready to load history, or user is not authenticated. Skipping history load.");
                if (state.db) {
                    historyTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 text-center">Please log in to view saved workout history.</td></tr>`;
                }
                return;
            }
            
            historyTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 text-center">Loading workout history...</td></tr>`;

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Define appId locally
                const workoutsCollectionRef = collection(state.db, `artifacts/${appId}/users/${state.userId}/classic_7_3_repeater_workout_summaries`); 
                const q = query(workoutsCollectionRef); 
                const querySnapshot = await getDocs(q);
                
                state.workoutHistorySummaries = [];
                querySnapshot.forEach((doc) => {
                    state.workoutHistorySummaries.push(doc.data());
                });
                
                state.workoutHistorySummaries.sort((a, b) => new Date(b.date) - new Date(a.date));

                renderWorkoutHistory();
                console.log("loadWorkoutHistory: Workout history loaded successfully.");
            } catch (e) {
                console.error("loadWorkoutHistory: Error loading workout history:", e);
                historyTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-red-600 text-center">Error loading history: ${e.message}.</td></tr>`;
            }
        }

        function renderWorkoutHistory() {
            historyTableBody.innerHTML = '';
            if (state.workoutHistorySummaries.length === 0) {
                historyTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 text-center">No past workouts logged yet.</td>
                    </tr>
                `;
                return;
            }
            state.workoutHistorySummaries.forEach(summary => {
                const row = historyTableBody.insertRow();
                row.className = 'hover:bg-slate-50';
                const workoutDate = new Date(summary.date);
                const formattedDate = workoutDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${formattedDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${summary.gripType}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${summary.weight}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${summary.setsPerGrip}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${summary.holdDuration}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${formatTime(summary.totalWorkoutDuration)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${formatTime(summary.totalLiftDuration)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${formatTime(summary.totalRestDuration)}</td>
                `;
            });
        }
        
        // --- Test Phase Logic ---
        function startTestTimer() {
            console.log("startTestTimer: Starting test timer.");
            clearInterval(state.testTimerId);
            startTestBtn.disabled = true;
            saveWeightBtn.disabled = true;
            state.testSeconds = 10;
            testTimerDisplay.textContent = state.testSeconds;
            
            state.testTimerId = setInterval(() => {
                state.testSeconds--;
                testTimerDisplay.textContent = state.testSeconds;
                if (state.testSeconds <= 0) {
                    clearInterval(state.testTimerId);
                    testTimerDisplay.textContent = "Test Complete!";
                    startTestBtn.disabled = false;
                    saveWeightBtn.disabled = false;
                    console.log("startTestTimer: Test complete.");
                }
            }, 1000);
        }

        function saveWeight() {
            console.log("saveWeight: Saving weight for workout.");
            state.workoutGripType = gripTestTypeInput.value;
            state.workoutWeight = parseFloat(testWeightInput.value);
            workoutGripTypeInput.value = state.workoutGripType;
            workoutWeightInput.value = state.workoutWeight;
        }

        // --- Main Workout Logic ---
        function startWorkoutFlow() {
            console.log("startWorkoutFlow: Starting workout flow.");
            // Hide setup, show engine
            workoutSetupDiv.classList.add('hidden');
            workoutEngineDiv.classList.remove('hidden');
            setActionsDiv.classList.add('hidden'); 
            cancelWorkoutBtn.classList.remove('hidden');
            upNextDisplay.classList.add('hidden');
            totalTimesDisplay.classList.add('hidden');

            // Update state from inputs
            state.workoutGripType = workoutGripTypeInput.value;
            state.workoutWeight = parseFloat(workoutWeightInput.value);
            state.setsPerGrip = parseInt(setsPerGripInput.value);

            // Reset for a new workout session
            state.currentSet = 1;
            state.currentRep = 1; // Start with first rep
            state.currentHandIndex = 0; // Starts with Right Hand
            state.currentSessionLifts = []; // Clear individual lifts from previous session
            state.totalLiftDuration = 0;
            state.totalRestDuration = 0;
            state.workoutStartTime = Date.now(); // Start tracking overall workout time

            renderCurrentSessionLifts(); // Clear the current session table

            state.currentWorkoutPhase = 'hold'; // Start with the first hold
            console.log("startWorkoutFlow: Calling runWorkoutPhase for initial hold.");
            runWorkoutPhase(); // Start the first lift
        }

        function runWorkoutPhase() {
            console.log(`runWorkoutPhase: Phase: ${state.currentWorkoutPhase}, Set: ${state.currentSet}, Rep: ${state.currentRep}, Hand: ${state.hands[state.currentHandIndex]}`);
            clearInterval(state.workoutTimerId);

            // Update display based on current phase and hand
            currentSetDisplay.textContent = `Set ${state.currentSet} of ${state.setsPerGrip}`;
            currentHandDisplay.textContent = `${state.hands[state.currentHandIndex]} Hand - Rep ${state.currentRep} of ${state.repsPerCycle}`; // Added rep counter
            setInfo.textContent = `Grip: ${state.workoutGripType} | Weight: ${state.workoutWeight} lbs/kg`;

            let currentTotalDuration = 0;

            // Set timer properties based on the current phase
            switch (state.currentWorkoutPhase) {
                case 'hold':
                    state.countdown = state.holdDuration;
                    timerStatus.textContent = "HOLD!";
                    timerStatus.classList.remove('text-green-600', 'text-slate-900');
                    timerStatus.classList.add('text-red-600');
                    progressRing.classList.remove('text-green-500');
                    progressRing.classList.add('text-teal-500');
                    currentTotalDuration = state.holdDuration;
                    break;
                case 'rest-short': // Rest between reps (3s)
                    state.countdown = state.restBetweenReps;
                    timerStatus.textContent = "REST";
                    timerStatus.classList.remove('text-red-600', 'text-slate-900');
                    timerStatus.classList.add('text-green-600');
                    progressRing.classList.remove('text-teal-500');
                    progressRing.classList.add('text-green-500');
                    currentTotalDuration = state.restBetweenReps;
                    break;
                case 'long-rest': // Rest after both hands complete a set (3min)
                    state.countdown = state.longRestDuration;
                    timerStatus.textContent = "LONG REST";
                    timerStatus.classList.remove('text-red-600', 'text-slate-900');
                    timerStatus.classList.add('text-green-600');
                    progressRing.classList.remove('text-teal-500');
                    progressRing.classList.add('text-green-500');
                    currentTotalDuration = state.longRestDuration;
                    break;
                default:
                    state.countdown = 0;
                    timerStatus.textContent = "Error";
                    currentTotalDuration = 1;
            }
            progressRing.style.strokeDashoffset = ringCircumference; // Reset ring to full for countdown

            // Display initial countdown value immediately
            timerCountdown.textContent = state.currentWorkoutPhase === 'long-rest' ? formatTime(state.countdown) : state.countdown;

            updateUpNextDisplay();

            state.workoutTimerId = setInterval(() => {
                // Update total durations based on the active phase
                if (state.currentWorkoutPhase === 'hold') {
                    state.totalLiftDuration++; // Accumulates hold time
                } else if (state.currentWorkoutPhase === 'rest-short' || state.currentWorkoutPhase === 'long-rest') {
                    state.totalRestDuration++;
                }

                state.countdown--;
                // Update countdown display
                timerCountdown.textContent = state.currentWorkoutPhase === 'long-rest' ? formatTime(state.countdown) : state.countdown;
                updateRing((state.countdown / currentTotalDuration) * 100);

                if (state.countdown < 0) {
                    console.log(`runWorkoutPhase: Countdown finished for ${state.currentWorkoutPhase}. Calling handlePhaseEnd.`);
                    handlePhaseEnd();
                }
            }, 1000);
        }

        function handlePhaseEnd() {
            clearInterval(state.workoutTimerId);
            console.log(`handlePhaseEnd: Current phase was ${state.currentWorkoutPhase}`);

            switch (state.currentWorkoutPhase) {
                case 'hold':
                    logLiftResult();
                    if (state.currentRep < state.repsPerCycle) {
                        state.currentRep++;
                        state.currentWorkoutPhase = 'rest-short'; // Go to 3s rest for next rep
                    } else { // All reps for current hand are done
                        state.currentRep = 1; // Reset rep counter for next hand/set
                        if (state.currentHandIndex === 0) { // Right hand finished its cycle of reps
                            state.currentHandIndex = 1; // Switch to Left hand
                            state.currentWorkoutPhase = 'hold'; // Left hand starts its reps immediately
                        } else { // Left hand finished its cycle of reps (both hands for this set are done)
                            state.currentHandIndex = 0; // Reset to Right hand for next set
                            state.currentSet++;
                            if (state.currentSet <= state.setsPerGrip) {
                                state.currentWorkoutPhase = 'long-rest'; // Go to 3min long rest
                            } else {
                                state.currentWorkoutPhase = 'completed'; // All sets done
                            }
                        }
                    }
                    break;
                case 'rest-short': // Finished 3s rest between reps
                    state.currentWorkoutPhase = 'hold'; // Go to the next rep's hold
                    break;
                case 'long-rest': // Finished 3min rest between sets
                    state.currentWorkoutPhase = 'hold'; // Start the first hold of the next set (Right hand)
                    break;
            }

            if (state.currentWorkoutPhase === 'completed') {
                console.log("handlePhaseEnd: Workout completed.");
                showWorkoutComplete();
            } else {
                console.log(`handlePhaseEnd: Transitioning to phase ${state.currentWorkoutPhase}. Calling runWorkoutPhase.`);
                runWorkoutPhase();
            }
        }
        
        // --- DOMContentLoaded Listener and Event Attachments ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("classicrepeaters.html: DOM Content Loaded!"); // Debugging log

            // Assign DOM element references
            startTestBtn = document.getElementById('start-test-btn');
            testTimerDisplay = document.getElementById('test-timer-display');
            testWeightInput = document.getElementById('test-weight');
            gripTestTypeInput = document.getElementById('grip-test-type');
            saveWeightBtn = document.getElementById('save-weight-btn');

            workoutGripTypeInput = document.getElementById('workout-grip-type');
            workoutWeightInput = document.getElementById('workout-weight');
            setsPerGripInput = document.getElementById('sets-per-grip-input'); 
            startWorkoutBtn = document.getElementById('start-workout-btn');
            cancelWorkoutBtn = document.getElementById('cancel-workout-btn');
            startNewWorkoutBtn = document.getElementById('start-new-workout-btn');

            workoutSetupDiv = document.getElementById('workout-setup');
            workoutEngineDiv = document.getElementById('workout-engine');
            timerStatus = document.getElementById('timer-status');
            timerCountdown = document.getElementById('timer-countdown');
            currentSetDisplay = document.getElementById('current-set-display');  
            currentHandDisplay = document.getElementById('current-hand-display');
            setInfo = document.getElementById('set-info');
            progressRing = document.getElementById('timer-progress-ring');
            
            currentSessionTableBody = document.getElementById('current-session-table-body');
            historyTableBody = document.getElementById('history-table-body');

            upNextDisplay = document.getElementById('up-next-display');  
            upNextText = document.getElementById('up-next-text');  
            setActionsDiv = document.getElementById('set-actions');
            totalTimesDisplay = document.getElementById('total-times-display');
            totalWorkoutTimeSpan = document.getElementById('total-workout-time');
            totalLiftTimeSpan = document.getElementById('total-lift-time');
            totalRestTimeSpan = document.getElementById('total-rest-time');

            userNamePlaceholder = document.getElementById('user-name-placeholder');
            userInfoDisplay = document.getElementById('user-info-display');
            registerLoginBtn = document.getElementById('register-login-btn');
            logoutBtn = document.getElementById('logout-btn');

            console.log("classicrepeaters.html: All DOM elements assigned."); // Debugging log

            // --- Firebase Initialization and Authentication ---
            let app;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            let firebaseConfig = {};

            try {
                firebaseConfig = JSON.parse(firebaseConfigString);
            } catch (e) {
                console.error("Error parsing __firebase_config:", e);
            }

            if (firebaseConfig && firebaseConfig.projectId) {
                try {
                    app = initializeApp(firebaseConfig);
                    state.db = getFirestore(app);
                    state.auth = getAuth(app);
                    console.log("classicrepeaters.html: Firebase Auth initialized.");

                    if (typeof __initial_auth_token !== 'undefined') {
                        try {
                            await signInWithCustomToken(state.auth, __initial_auth_token);
                            console.log("classicrepeaters.html: Signed in with custom token.");
                        } catch (tokenError) {
                            console.warn("classicrepeaters.html: Custom token sign-in failed:", tokenError.message);
                        }
                    }

                    onAuthStateChanged(state.auth, (user) => {
                        if (user) {
                            state.userId = user.uid;
                            console.log("classicrepeaters.html: Firebase user ID:", state.userId);
                            loadWorkoutHistory(); // Load history after user is authenticated

                            // Update UI for logged-in user
                            userNamePlaceholder.textContent = user.displayName || user.email || user.uid.substring(0, 8);
                            userInfoDisplay.classList.remove('hidden');
                            registerLoginBtn.classList.add('hidden');
                            logoutBtn.classList.remove('hidden');

                        } else {
                            state.userId = crypto.randomUUID(); 
                            console.log("classicrepeaters.html: No user signed in. Using random ID for local operations:", state.userId);

                            // Update UI for logged-out user
                            userNamePlaceholder.textContent = "Guest";
                            userInfoDisplay.classList.add('hidden');
                            registerLoginBtn.classList.remove('hidden');
                            logoutBtn.classList.add('hidden');
                            historyTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 text-center">Please log in to view saved workout history.</td></tr>`;
                        }
                    });
                    // Logout button event listener
                    logoutBtn.addEventListener('click', async () => {
                        try {
                            await signOut(state.auth);
                            console.log("classicrepeaters.html: User logged out.");
                            window.location.href = 'reg.html'; // Redirect to login page
                        } catch (error) {
                            console.error("classicrepeaters.html: Error logging out:", error);
                        }
                    });
                } catch (error) {
                    console.error("classicrepeaters.html: Error during Firebase initialization:", error);
                    historyTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-red-600 text-center">Error setting up Firebase: ${error.message}. Cloud persistence will not be available.</td></tr>`;
                    state.userId = crypto.randomUUID(); 
                }
            } else {
                console.warn("classicrepeaters.html: Firebase config is missing projectId or is empty. Cloud persistence will not be available.");
                historyTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-yellow-600 text-center">Cloud persistence not available. Firebase project ID missing from configuration.</td></tr>`;
                state.userId = crypto.randomUUID(); 
            }

            // Attach Event Listeners
            startTestBtn.addEventListener('click', () => startTestTimer());
            saveWeightBtn.addEventListener('click', () => saveWeight());
            startWorkoutBtn.addEventListener('click', () => {
                console.log("classicrepeaters.html: Start Workout button clicked!"); // Debugging log
                startWorkoutFlow();
            });
            cancelWorkoutBtn.addEventListener('click', () => resetWorkoutForNewSession());
            startNewWorkoutBtn.addEventListener('click', () => resetWorkoutForNewSession());

            loadWorkoutHistory(); // Initial load of history on page load
        });
    </script>
</body>
</html>

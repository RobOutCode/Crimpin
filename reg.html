<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up or Log In</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .auth-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        input:focus {
            outline: none;
            border-color: #14b8a6; /* Teal */
            box-shadow: 0 0 0 2px rgba(20, 184, 166, 0.5); /* Teal ring */
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex items-center justify-center min-h-screen">

    <div class="auth-card p-8 w-full max-w-md">
        <h1 class="text-3xl font-bold text-slate-900 text-center mb-6" id="auth-title">Sign Up</h1>
        
        <form id="auth-form" class="space-y-4">
            <div>
                <label for="email" class="block text-sm font-medium text-slate-700">Email Address</label>
                <input type="email" id="email" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2" required>
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-slate-700">Password</label>
                <input type="password" id="password" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2" required minlength="6">
            </div>
            <button type="submit" id="auth-button" class="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-700 transition duration-300">Sign Up</button>
        </form>

        <p class="mt-4 text-center text-sm">
            <button id="toggle-auth-mode" class="text-teal-600 hover:text-teal-800 transition duration-300">Already have an account? Log In</button>
        </p>

        <div id="auth-message" class="mt-4 text-center text-sm font-medium text-red-600"></div>
    </div>

    <script>
        // This is the 'appId' field from your firebaseConfig, used by your existing code
        const __app_id = "1:1069153831535:web:b5275caff1a948aa831b9a"; // Replace with your actual appId

        // This is your full Firebase project configuration object, stringified for your existing code
        const __firebase_config = JSON.stringify({
          apiKey: "AIzaSyChVyJ-FU_q2ecKum3kVj8ptV-Z0_jGIgY", // Replace with your actual apiKey
          authDomain: "crimptheory.firebaseapp.com", // Replace with your actual authDomain
          projectId: "crimptheory", // Replace with your actual projectId
          storageBucket: "crimptheory.appspot.com", // Replace with your actual storageBucket
          messagingSenderId: "1069153831535", // Replace with your actual messagingSenderId
          appId: "1:1069153831535:web:b5275caff1a948aa831b9a", // Replace with your actual appId
          measurementId: "G-8DGM79J607" // Replace with your actual measurementId (optional)
        });
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        document.addEventListener('DOMContentLoaded', () => {
            const authForm = document.getElementById('auth-form');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const authButton = document.getElementById('auth-button');
            const authTitle = document.getElementById('auth-title');
            const toggleAuthModeBtn = document.getElementById('toggle-auth-mode');
            const authMessage = document.getElementById('auth-message');

            let isSignUpMode = true; // State to track if we are in sign-up or log-in mode
            let redirectInitiated = false; // Flag to prevent multiple redirects

            // Initialize Firebase (using provided global config)
            const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            let firebaseConfig = {};
            try {
                firebaseConfig = JSON.parse(firebaseConfigString);
            } catch (e) {
                console.error("Error parsing __firebase_config:", e);
            }

            let auth = null;
            if (firebaseConfig && firebaseConfig.projectId) {
                try {
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    console.log("Firebase Auth initialized.");
                } catch (error) {
                    console.error("Error initializing Firebase Auth:", error);
                    authMessage.textContent = "Error: Firebase initialization failed. Authentication unavailable.";
                }
            } else {
                console.warn("Firebase config is missing projectId. Authentication will not be available.");
                authMessage.textContent = "Error: Firebase configuration missing. Authentication unavailable.";
            }

            // Function to handle redirection
            function redirectToHome(delay = 100) { // Reduced delay
                if (redirectInitiated) {
                    return; // Prevent multiple redirects
                }
                redirectInitiated = true;
                
                authMessage.textContent = `Already logged in. Redirecting to home...`; // Update message
                
                setTimeout(() => { // Add a small delay for the message to be seen
                    const redirectUrl = new URLSearchParams(window.location.search).get('redirect');
                    if (redirectUrl) {
                        window.location.href = `?artifact=${redirectUrl}`;
                    } else {
                        // For Canvas environment, this is the most reliable way to navigate between artifacts
                        window.location.href = '?artifact=home-page'; 
                    }
                    // Attempt to stop further script execution on this page
                    window.stop(); 
                }, delay);
            }

            // Check authentication state on load
            if (auth) {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("User already signed in:", user.email || user.uid);
                        redirectToHome(); // Redirect if already signed in
                        return; // Stop further execution in this callback
                    } else {
                        console.log("No user signed in.");
                    }
                });
            }

            // Handle form submission (Sign Up or Log In)
            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                authMessage.textContent = ''; // Clear previous messages
                if (!auth) {
                    authMessage.textContent = "Authentication is not available due to Firebase setup issues.";
                    return;
                }

                const email = emailInput.value;
                const password = passwordInput.value;

                try {
                    if (isSignUpMode) {
                        await createUserWithEmailAndPassword(auth, email, password);
                        authMessage.textContent = "Sign Up successful! Redirecting...";
                        console.log("Sign up successful!");
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                        authMessage.textContent = "Log In successful! Redirecting...";
                        console.log("Login successful!");
                    }
                    redirectToHome(); // Redirect on successful sign-up/login
                    return; // Stop further execution in this callback
                } catch (error) {
                    console.error("Authentication error:", error.code, error.message);
                    let displayMessage = "An unexpected error occurred.";
                    switch (error.code) {
                        case 'auth/email-already-in-use':
                            displayMessage = "Email already in use. Try logging in.";
                            break;
                        case 'auth/invalid-email':
                            displayMessage = "Invalid email address.";
                            break;
                        case 'auth/weak-password':
                            displayMessage = "Password should be at least 6 characters.";
                            break;
                        case 'auth/user-not-found':
                        case 'auth/wrong-password':
                            displayMessage = "Invalid email or password.";
                            break;
                        case 'auth/operation-not-allowed':
                            displayMessage = "Email/password accounts are not enabled. Contact support.";
                            break;
                        case 'auth/network-request-failed':
                            displayMessage = "Network error. Please check your internet connection.";
                            break;
                        default:
                            displayMessage = `Error: ${error.message}`;
                    }
                    authMessage.textContent = displayMessage;
                }
            });

            // Toggle between Sign Up and Log In modes
            toggleAuthModeBtn.addEventListener('click', () => {
                isSignUpMode = !isSignUpMode;
                if (isSignUpMode) {
                    authTitle.textContent = "Sign Up";
                    authButton.textContent = "Sign Up";
                    toggleAuthModeBtn.textContent = "Already have an account? Log In";
                } else {
                    authTitle.textContent = "Log In";
                    authButton.textContent = "Log In";
                    toggleAuthModeBtn.textContent = "Don't have an account? Sign Up";
                }
                authMessage.textContent = ''; // Clear message on mode change
            });
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Workout History</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .section-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0; /* slate-200 */
        }
        th {
            background-color: #f8fafc; /* slate-50 */
            font-size: 0.75rem; /* text-xs */
            font-weight: 500; /* font-medium */
            color: #64748b; /* slate-500 */
            text-transform: uppercase;
            letter-spacing: 0.05em; /* tracking-wider */
        }
        tbody tr:hover {
            background-color: #f8fafc; /* slate-50 */
        }
        .empty-message {
            text-align: center;
            padding: 1.5rem;
            color: #64748b; /* slate-500 */
            font-size: 0.875rem; /* text-sm */
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="max-w-6xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center mb-4">
            <div id="user-info-display" class="text-slate-700 font-medium hidden">
                Welcome, <span id="user-name-placeholder" class="text-teal-600">Guest</span>!
            </div>
            <div class="flex space-x-2">
                <!-- Corrected href to reg.html for consistency -->
                <a href="reg.html" id="register-login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">Register / Log In</a>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 hidden">Log Out</button>
            </div>
        </div>
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-900">Your Full Workout History</h1>
            <p class="mt-4 text-lg text-slate-600">A consolidated view of all your logged training sessions.</p>
        </header>

        <main class="space-y-10">

            <section id="user-info" class="section-card p-6 md:p-8">
                <h2 class="text-2xl font-bold text-slate-900 mb-4">User Information</h2>
                <p class="text-slate-600">Your unique ID for this session: <span id="user-id-display" class="font-mono text-slate-900 bg-slate-100 p-2 rounded-md">Loading...</span></p>
                <p id="firebase-status" class="mt-2 text-sm text-slate-500">Firebase Status: Initializing...</p>
            </section>

            <section id="all-workouts-history" class="section-card p-6 md:p-8">
                <h2 class="text-2xl font-bold text-slate-900 mb-4">All Logged Workouts</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead>
                            <tr>
                                <th scope="col">Date</th>
                                <th scope="col">Protocol</th>
                                <th scope="col">Grip/Pinch</th>
                                <th scope="col">Weight</th>
                                <th scope="col">Sets/Cycles</th>
                                <th scope="col">Hold Dur. (s)</th>
                                <th scope="col">Total Workout Time</th>
                                <th scope="col">Total Hold Time</th>
                                <th scope="col">Total Rest Time</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="bg-white divide-y divide-slate-200">
                            <tr>
                                <td colspan="9" class="empty-message">Loading workout history...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

        </main>
    </div>

    <script>
        // This is the 'appId' field from your firebaseConfig, used by your existing code
        const __app_id = "1:1069153831535:web:b5275caff1a948aa831b9a"; // Replace with your actual appId

        // This is your full Firebase project configuration object, stringified for your existing code
        const __firebase_config = JSON.stringify({
          apiKey: "AIzaSyChVyJ-FU_q2ecKum3kVj8ptV-Z0_jGIgY", // Replace with your actual apiKey
          authDomain: "crimptheory.firebaseapp.com", // Replace with your actual authDomain
          projectId: "crimptheory", // Replace with your actual projectId
          storageBucket: "crimptheory.appspot.com", // Replace with your actual storageBucket
          messagingSenderId: "1069153831535", // Replace with your actual messagingSenderId
          appId: "1:1069153831535:web:b5275caff1a948aa831b9a", // Replace with your actual appId
          measurementId: "G-8DGM79J607" // Replace with your actual measurementId (optional)
        });
    </script>

    <script type="module">
        console.clear(); // Clear console on every load for clean debugging

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            console.log("history.html: DOM Content Loaded.");

            const state = {
                db: null,
                auth: null,
                userId: 'Loading...',
                workoutHistory: [] // To store all combined workout summaries
            };

            // DOM Elements
            const userIdDisplay = document.getElementById('user-id-display');
            const firebaseStatusDisplay = document.getElementById('firebase-status');
            const historyTableBody = document.getElementById('history-table-body');
            
            // User Info & Logout Button
            const userNamePlaceholder = document.getElementById('user-name-placeholder');
            const userInfoDisplay = document.getElementById('user-info-display');
            const registerLoginBtn = document.getElementById('register-login-btn');
            const logoutBtn = document.getElementById('logout-btn');

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            let firebaseConfig = {};

            // List of all protocol history collections
            const protocolCollections = [
                "max_weight_workout_summaries",
                "tension_repeater_workout_summaries",
                "classic_7_3_repeater_workout_summaries",
                "pinch_block_workout_summaries"
            ];

            // Utility function to format time
            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.floor(seconds % 60);
                return `${minutes}m ${remainingSeconds}s`;
            }

            // --- Firebase Initialization and Authentication ---
            try {
                firebaseConfig = JSON.parse(firebaseConfigString);
                if (firebaseConfig && firebaseConfig.projectId) {
                    console.log("history.html: Initializing Firebase App.");
                    const app = initializeApp(firebaseConfig);
                    state.db = getFirestore(app);
                    state.auth = getAuth(app);
                    firebaseStatusDisplay.textContent = "Firebase Status: Connected.";
                    console.log("history.html: Firebase Auth and Firestore initialized.");

                    // Only attempt custom token sign-in. If not present or fails, onAuthStateChanged will handle.
                    if (typeof __initial_auth_token !== 'undefined') {
                        try {
                            console.log("history.html: Attempting custom token sign-in.");
                            await signInWithCustomToken(state.auth, __initial_auth_token);
                            console.log("history.html: Signed in with custom token.");
                        } catch (tokenError) {
                            console.warn("history.html: Custom token sign-in failed:", tokenError.message);
                            firebaseStatusDisplay.textContent = `Firebase Status: Auth failed (${tokenError.message}).`;
                        }
                    } else {
                        console.log("history.html: No custom token provided. Relying on onAuthStateChanged for user state.");
                    }

                    onAuthStateChanged(state.auth, (user) => {
                        if (user) {
                            state.userId = user.uid;
                            userIdDisplay.textContent = state.userId;
                            console.log("history.html: User signed in. UID:", state.userId);
                            loadAllWorkoutHistory(); // Load history after user is authenticated

                            // Update UI for logged-in user
                            userNamePlaceholder.textContent = user.displayName || user.email || user.uid.substring(0, 8);
                            userInfoDisplay.classList.remove('hidden');
                            registerLoginBtn.classList.add('hidden');
                            logoutBtn.classList.remove('hidden');

                        } else {
                            state.userId = crypto.randomUUID(); // Fallback for local session data
                            userIdDisplay.textContent = `Anonymous (Local: ${state.userId.substring(0, 8)}...)`; // Show truncated random ID
                            firebaseStatusDisplay.textContent = "Firebase Status: Not authenticated. Data is local to this session or requires login.";
                            console.log("history.html: No user signed in. Using random ID for local operations:", state.userId);
                            loadAllWorkoutHistory(); // Still attempt to load, but Firestore rules might block for anonymous users

                            // Update UI for logged-out user
                            userNamePlaceholder.textContent = "Guest";
                            userInfoDisplay.classList.add('hidden');
                            registerLoginBtn.classList.remove('hidden');
                            logoutBtn.classList.add('hidden');
                            historyTableBody.innerHTML = `<tr><td colspan="9" class="empty-message">Please log in to view saved workout history.</td></tr>`;
                        }
                    });
                    // Logout button event listener
                    logoutBtn.addEventListener('click', async () => {
                        try {
                            await signOut(state.auth);
                            console.log("history.html: User logged out.");
                            window.location.href = 'reg.html'; // Redirect to login page
                        } catch (error) {
                            console.error("history.html: Error logging out:", error);
                        }
                    });
                } catch (error) {
                    console.error("history.html: Error during Firebase initialization:", error);
                    firebaseStatusDisplay.textContent = `Firebase Status: Error (${error.message}). Cloud persistence unavailable.`;
                    state.userId = "Local Session (Error)";
                    userIdDisplay.textContent = state.userId;
                    historyTableBody.innerHTML = `<tr><td colspan="9" class="empty-message">Error setting up Firebase: ${error.message}. Cloud persistence will not be available.</td></tr>`;
                }
            } else {
                console.warn("history.html: Firebase config is missing projectId or is empty. Cloud persistence will not be available.");
                firebaseStatusDisplay.textContent = "Firebase Status: Configuration Missing. Cloud persistence unavailable.";
                state.userId = "Local Session (No Cloud)";
                userIdDisplay.textContent = state.userId;
                historyTableBody.innerHTML = `<tr><td colspan="9" class="empty-message">Cloud persistence not available. Firebase project ID missing from configuration.</td></tr>`;
            }

            // --- Load All Workout History ---
            async function loadAllWorkoutHistory() {
                console.log("history.html: loadAllWorkoutHistory called.");
                // Ensure Firebase is ready and userId is available (even if it's the "Anonymous (Local)" placeholder)
                // If user is truly anonymous and Firebase rules don't allow reads, this will result in permission denied.
                if (!state.db || !state.userId || state.userId === 'Loading...') { 
                    console.warn("history.html: Firebase not ready to load history, or user ID is unavailable. Skipping history load.");
                    historyTableBody.innerHTML = `<tr><td colspan="9" class="empty-message">Cannot load history. Firebase not initialized or user ID is unavailable.</td></tr>`;
                    return;
                }
                // If user is anonymous (random UUID generated in onAuthStateChanged) AND db is initialized, proceed.
                // Firebase security rules will then determine if read is allowed for this anonymous ID.
                if (state.userId.startsWith('Anonymous') && !state.db) {
                     console.warn("history.html: Not authenticated and Firebase DB not initialized. Cannot load cloud history.");
                     historyTableBody.innerHTML = `<tr><td colspan="9" class="empty-message">Not authenticated and cloud database not available.</td></tr>`;
                     return;
                }


                historyTableBody.innerHTML = `<tr><td colspan="9" class="empty-message">Loading all workout history...</td></tr>`;
                state.workoutHistory = []; // Clear previous data

                for (const collectionName of protocolCollections) {
                    try {
                        const workoutsCollectionRef = collection(state.db, `artifacts/${appId}/users/${state.userId}/${collectionName}`);
                        console.log(`history.html: Querying collection: artifacts/${appId}/users/${state.userId}/${collectionName}`);
                        const q = query(workoutsCollectionRef); 
                        const querySnapshot = await getDocs(q);
                        
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            // Add protocol name to the data for display
                            let protocolDisplayName = collectionName
                                .replace(/_workout_summaries$/, '')
                                .replace(/_individual_reps$/, '') // Added for 7-53 if it were to fetch reps, though we fetch summaries
                                .replace(/_/g, ' ')
                                .replace(/\b\w/g, char => char.toUpperCase()); // Capitalize first letter of each word
                            
                            // Adjust display name for specific protocols
                            if (protocolDisplayName.includes('Max Weight')) {
                                protocolDisplayName = 'Max Weight 7-10s Lifts';
                            } else if (protocolDisplayName.includes('Tension Repeater')) {
                                protocolDisplayName = "Tension 'Standard' Repeaters";
                            } else if (protocolDisplayName.includes('Classic 7 3 Repeater')) {
                                protocolDisplayName = 'Classic 7/3 Repeaters';
                            } else if (protocolDisplayName.includes('Pinch Block')) {
                                protocolDisplayName = 'Pinch Block Lifts';
                            }

                            state.workoutHistory.push({
                                ...data,
                                protocol: protocolDisplayName // Add the protocol name
                            });
                            console.log(`history.html: Added workout from ${collectionName}:`, data);
                        });
                    } catch (e) {
                        console.error(`history.html: Error loading history from ${collectionName}:`, e);
                        if (e.code === 'permission-denied') {
                             historyTableBody.innerHTML = `<tr><td colspan="9" class="empty-message">Access denied to workout history. Please ensure you are logged in and have correct permissions.</td></tr>`;
                             // Only return here if it's a critical permission error that applies broadly
                             // If a user can read some collections but not others, let it continue.
                        }
                    }
                }
                
                // Sort all combined history by date in descending order
                state.workoutHistory.sort((a, b) => new Date(b.date) - new Date(a.date));

                renderWorkoutHistory();
                console.log("history.html: All workout history loaded and rendered.");
            }

            // --- Render All Workout History to Table ---
            function renderWorkoutHistory() {
                console.log("history.html: Rendering workout history. Total items:", state.workoutHistory.length);
                historyTableBody.innerHTML = '';
                if (state.workoutHistory.length === 0) {
                    historyTableBody.innerHTML = `<tr><td colspan="9" class="empty-message">No workouts logged yet across all protocols.</td></tr>`;
                    return;
                }

                state.workoutHistory.forEach(summary => {
                    const row = historyTableBody.insertRow();
                    const workoutDate = new Date(summary.date);
                    const formattedDate = workoutDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    
                    // Determine appropriate 'Sets/Cycles' and 'Hold Dur.' based on protocol
                    let setsOrCycles = 'N/A';
                    let holdDuration = 'N/A';

                    if (summary.protocol === 'Max Weight 7-10s Lifts') {
                        setsOrCycles = summary.numSets || 'N/A';
                        holdDuration = summary.liftDurationPerHold || 'N/A';
                    } else if (summary.protocol === "Tension 'Standard' Repeaters") {
                        // Assuming setsCompleted or similar from 7-53.html summary
                        setsOrCycles = summary.setsCompleted || 'N/A'; 
                        holdDuration = summary.liftDurationPerRep || 'N/A'; 
                    } else if (summary.protocol === 'Classic 7/3 Repeaters') {
                        setsOrCycles = summary.setsPerGrip || 'N/A';
                        holdDuration = summary.holdDuration || 'N/A';
                    } else if (summary.protocol === 'Pinch Block Lifts') {
                        setsOrCycles = summary.totalCycles || 'N/A';
                        holdDuration = summary.holdDuration || 'N/A';
                    }

                    row.innerHTML = `
                        <td>${formattedDate}</td>
                        <td>${summary.protocol}</td>
                        <td>${summary.gripType || summary.pinchType || 'N/A'}</td>
                        <td>${summary.weight || 'N/A'}</td>
                        <td>${setsOrCycles}</td>
                        <td>${holdDuration}</td>
                        <td>${formatTime(summary.totalWorkoutDuration || 0)}</td>
                        <td>${formatTime(summary.totalLiftDuration || 0)}</td>
                        <td>${formatTime(summary.totalRestDuration || 0)}</td>
                    `;
                });
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Max Weight 7-10 Second Lifts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .section-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .details-marker::marker {
            color: #14b8a6;
        }
        .timer-circle {
            transition: stroke-dashoffset 1s linear;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="max-w-4xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
        
        <header class="text-center mb-12">
            <p class="text-sm mb-2"><a href="home.html" class="text-teal-600 hover:text-teal-800 font-semibold">‚Üê Back to Workout Protocols</a></p>
            <h1 class="text-4xl md:text-5xl font-bold text-slate-900">Interactive Max Weight 7-10 Second Lifts</h1>
            <p class="mt-4 text-lg text-slate-600">Your guided session for maximal finger strength protocol (7-10s holds).</p>
        </header>

        <main class="space-y-10">

            <section id="setup" class="section-card p-6 md:p-8">
                <h2 class="text-2xl font-bold text-slate-900 mb-4">Before You Start</h2>
                <div class="space-y-6">
                    <article>
                        <h3 class="text-lg font-semibold text-teal-600 mb-2">‚ö†Ô∏è Safety Disclaimer</h3>
                        <ul class="list-disc list-inside space-y-1 text-slate-600">
                            <li>A thorough warm-up is crucial. Do not skip this phase.</li>
                            <li>Listen to your body. Stop immediately if you feel sharp pain. Soreness is normal, pain is not.</li>
                            <li>Consult a professional if you have pre-existing injuries or concerns.</li>
                        </ul>
                    </article>
                    <article>
                        <h3 class="text-lg font-semibold text-teal-600 mb-2">üõ†Ô∏è Required Equipment</h3>
                           <ul class="list-disc list-inside space-y-1 text-slate-600">
                            <li>Tension Block</li>
                            <li>Loading Pin & Weights</li>
                            <li>Timer (this app will handle it!)</li>
                            <li>Notebook/App to log progress (recommended)</li>
                        </ul>
                    </article>
                </div>
            </section>

            <section id="warmup" class="section-card">
                <details class="p-6 md:p-8">
                    <summary class="text-2xl font-bold text-slate-900 cursor-pointer details-marker">Phase 1: Dynamic Warm-up (15-20 min)</summary>
                    <div class="mt-6 border-t border-slate-200 pt-6 space-y-4 text-slate-600">
                        <p>This phase gradually prepares your body for intense work. Complete all steps.</p>
                        <ul class="list-decimal list-inside space-y-2">
                            <li><strong>General Cardio (5 min):</strong> Light jog, jumping jacks, or cycling.</li>
                            <li><strong>Dynamic Stretches & Mobility (5-7 min):</strong> Arm circles, shoulder rolls, wrist circles, and finger extensions.</li>
                            <li><strong>Light Pulls on Tension Block (5-8 min):</strong> Perform light, low-intensity pulls with various grips. This includes 2-3 ramp-up sets, gradually increasing weight to 80% of your estimated working weight.</li>
                        </ul>
                    </div>
                </details>
            </section>
            
            <section id="weight-test" class="section-card p-6 md:p-8">
                <h2 class="text-2xl font-bold text-slate-900 mb-2">Phase 2: Determine Your Training Weight (10s Max)</h2>
                <p class="mb-6 text-slate-600">Find the max weight you can hold for **exactly 10 seconds** on a specific grip. This will be your training weight for the 7-10 second working lifts. Rest 3-5 minutes between each test attempt.</p>
                <div class="bg-slate-100 p-6 rounded-lg">
                    <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                        <div>
                             <label for="grip-test-type" class="block text-sm font-medium text-slate-700">Grip Type</label>
                           <input type="text" id="grip-test-type" value="20mm Half-Crimp" class="mt-1 block w-full sm:w-48 rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                        </div>
                        <div>
                            <label for="test-weight" class="block text-sm font-medium text-slate-700">Test Weight (lbs/kg)</label>
                            <input type="number" id="test-weight" value="40" class="mt-1 block w-full sm:w-32 rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                        </div>
                        <button id="start-test-btn" class="w-full sm:w-auto bg-teal-500 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-600 transition duration-300">Start 10s Test</button>
                    </div>
                    <div id="test-timer-display" class="mt-4 text-center text-3xl font-bold text-slate-700 h-10"></div>
                     <div class="mt-4 text-center">
                        <button id="save-weight-btn" class="w-full sm:w-auto bg-slate-600 text-white font-bold py-2 px-6 rounded-md hover:bg-slate-700 transition duration-300 disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>Save Weight for Workout</button>
                    </div>
                </div>
            </section>

            <section id="main-workout" class="section-card p-6 md:p-8">
                <h2 class="text-2xl font-bold text-slate-900 mb-2">Phase 3: Max Weight 7-10 Second Lifts</h2>
                <p class="mb-6 text-slate-600">This protocol focuses on high intensity and short duration holds to increase maximal force generation. It adapts max hang principles for block lifting. Complete 1 lift per hand per set. The timer will guide you through each lift and rest period.</p>
                
                <div id="workout-setup" class="bg-slate-100 p-6 rounded-lg space-y-4">
                    <div>
                        <label for="workout-grip-type" class="block text-sm font-medium text-slate-700">Grip Type for this Workout</label>
                        <input type="text" id="workout-grip-type" value="20mm Half-Crimp" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                    </div>
                    <div class="flex flex-col sm:flex-row justify-between gap-4">
                         <div class="flex-1">
                            <label for="workout-weight" class="block text-sm font-medium text-slate-700">Training Weight (lbs/kg)</label>
                            <input type="number" id="workout-weight" value="40" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                        </div>
                         <div class="flex-1">
                            <label for="workout-lift-duration" class="block text-sm font-medium text-slate-700">Lift Duration (seconds)</label>
                            <input type="number" id="workout-lift-duration" value="7" min="7" max="10" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                        </div>
                    </div>
                    <div>
                        <label for="workout-num-sets" class="block text-sm font-medium text-slate-700">Number of Sets (3-5)</label>
                        <input type="number" id="workout-num-sets" value="3" min="3" max="5" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                    </div>
                    <button id="start-workout-btn" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-md hover:bg-red-700 transition duration-300 text-lg">Start Workout</button>
                </div>

                <div id="workout-engine" class="hidden text-center mt-6">
                    <div class="relative w-48 h-48 mx-auto mb-4">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="text-slate-200" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                            <circle id="timer-progress-ring" class="text-teal-500 timer-circle" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" stroke-linecap="round" transform="rotate(-90 50 50)" style="stroke-dasharray: 283; stroke-dashoffset: 283;"></circle>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <div id="timer-status" class="text-3xl font-bold text-slate-900">LIFT!</div>
                            <div id="timer-countdown" class="text-5xl font-bold text-slate-700">7</div>
                        </div>
                    </div>
                    <div id="current-set-display" class="text-xl font-bold text-slate-800 mb-2">Set 1 of 3</div>
                    <div id="current-hand-display" class="text-lg font-semibold text-slate-600">Right Hand</div>
                    <div id="set-info" class="mt-2 text-md text-slate-500"></div>
                    <div id="total-times-display" class="mt-4 text-base text-slate-700 hidden">
                        <p>Total Workout Time: <span id="total-workout-time">0m 0s</span></p>
                        <p>Total Lift Time: <span id="total-lift-time">0m 0s</span></p>
                        <p>Total Rest Time: <span id="total-rest-time">0m 0s</span></p>
                    </div>
                     <div id="set-actions" class="mt-6 hidden flex flex-col sm:flex-row justify-center gap-4">
                        <button id="start-new-workout-btn" class="bg-slate-600 text-white font-bold py-2 px-6 rounded-md hover:bg-slate-700 transition duration-300">Start New Workout</button>
                    </div>
                    <button id="cancel-workout-btn" class="mt-6 w-full sm:w-auto bg-gray-500 text-white font-bold py-2 px-6 rounded-md hover:bg-gray-600 transition duration-300">Cancel Workout</button>
                </div>
                <div id="up-next-display" class="mt-6 text-center text-lg font-semibold text-slate-700 hidden">
                    Up Next: <span id="up-next-text"></span>
                </div>
            </section>
            
            <section id="current-session-lifts" class="section-card p-6 md:p-8">
                <h2 class="text-2xl font-bold text-slate-900 mb-4">Current Session Lifts</h2>
                <div id="results-table-container" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Grip Type</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Hand</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Set #</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Lift Duration (s)</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Weight (lbs/kg)</th>
                            </tr>
                        </thead>
                        <tbody id="current-session-table-body" class="bg-white divide-y divide-slate-200">
                            <tr>
                                <td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 text-center">No lifts logged in current session.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="workout-history" class="section-card p-6 md:p-8">
                <h2 class="text-2xl font-bold text-slate-900 mb-4">Past Workout History</h2>
                <div id="history-table-container" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Grip</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Weight</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Sets</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Lift Dur.</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Total Workout Time</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Total Lift Time</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Total Rest Time</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="bg-white divide-y divide-slate-200">
                            <tr>
                                <td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 text-center">Loading workout history...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="cooldown" class="section-card">
                 <details class="p-6 md:p-8">
                    <summary class="text-2xl font-bold text-slate-900 cursor-pointer details-marker">Phase 4: Cool-down (5-10 min)</summary>
                    <div class="mt-6 border-t border-slate-200 pt-6 space-y-4 text-slate-600">
                        <p>Helps transition your body to a state of recovery.</p>
                        <ul class="list-decimal list-inside space-y-2">
                           <li><strong>General Shaking:</strong> Shake out hands and arms to release tension.</li>
                           <li><strong>Static Stretches (20-30s each):</strong> Gently stretch forearm flexors and extensors, wrists, and fingers.</li>
                        </ul>
                    </div>
                </details>
            </section>

        </main>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            const state = {
                // Firebase
                db: null,
                auth: null,
                userId: 'anonymous', // Default to anonymous

                // Test Phase State
                testWeight: 40,
                testTimerId: null,
                testSeconds: 10,

                // Workout Phase State
                workoutGripType: '20mm Half-Crimp',
                workoutWeight: 40,
                workoutTimerId: null,
                currentSet: 1, // Current set number (1 to maxSets)
                maxSets: 3, // Configurable by user (3-5)
                currentLiftHandIndex: 0, // 0 for Right, 1 for Left
                hands: ['Right', 'Left'],
                liftDuration: 7, // Configurable by user (7-10)
                restDuration: 180, // 3 minutes for rest between hands and between sets
                countdown: 0,
                currentPhase: 'setup', // 'setup', 'lifting', 'resting', 'complete'

                // Time Tracking
                workoutStartTime: null,
                totalWorkoutDuration: 0, // Overall elapsed time for the workout session
                totalLiftDuration: 0,   // Accumulated time under tension
                totalRestDuration: 0,   // Accumulated rest time

                // Data Storage
                currentSessionLifts: [], // Individual lift details for the current session
                workoutHistorySummaries: [] // Summaries of past workout sessions
            };

            // DOM Elements
            const startTestBtn = document.getElementById('start-test-btn');
            const testTimerDisplay = document.getElementById('test-timer-display');
            const testWeightInput = document.getElementById('test-weight');
            const gripTestTypeInput = document.getElementById('grip-test-type');
            const saveWeightBtn = document.getElementById('save-weight-btn');

            const workoutGripTypeInput = document.getElementById('workout-grip-type');
            const workoutWeightInput = document.getElementById('workout-weight');
            const workoutLiftDurationInput = document.getElementById('workout-lift-duration');
            const workoutNumSetsInput = document.getElementById('workout-num-sets');
            const startWorkoutBtn = document.getElementById('start-workout-btn');
            const cancelWorkoutBtn = document.getElementById('cancel-workout-btn');
            const startNewWorkoutBtn = document.getElementById('start-new-workout-btn');

            const workoutSetupDiv = document.getElementById('workout-setup');
            const workoutEngineDiv = document.getElementById('workout-engine');
            const timerStatus = document.getElementById('timer-status');
            const timerCountdown = document.getElementById('timer-countdown');
            const currentSetDisplay = document.getElementById('current-set-display');  
            const currentHandDisplay = document.getElementById('current-hand-display');
            const setInfo = document.getElementById('set-info');
            const progressRing = document.getElementById('timer-progress-ring');
            
            const currentSessionTableBody = document.getElementById('current-session-table-body'); // Changed ID
            const historyTableBody = document.getElementById('history-table-body'); // New for history summaries

            const upNextDisplay = document.getElementById('up-next-display');  
            const upNextText = document.getElementById('up-next-text');  
            const setActionsDiv = document.getElementById('set-actions');
            const totalTimesDisplay = document.getElementById('total-times-display');
            const totalWorkoutTimeSpan = document.getElementById('total-workout-time');
            const totalLiftTimeSpan = document.getElementById('total-lift-time');
            const totalRestTimeSpan = document.getElementById('total-rest-time');

            const ringCircumference = 2 * Math.PI * 45;  

            // --- Firebase Initialization and Authentication ---
            let app;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            let firebaseConfig = {}; // Initialize to empty object

            try {
                firebaseConfig = JSON.parse(firebaseConfigString);
            } catch (e) {
                console.error("Error parsing __firebase_config:", e);
                // firebaseConfig remains empty object, will trigger the warning below
            }

            if (firebaseConfig && firebaseConfig.projectId) { // Check if projectId exists
                try {
                    app = initializeApp(firebaseConfig);
                    state.db = getFirestore(app);
                    state.auth = getAuth(app);

                    // Sign in with custom token or anonymously
                    if (typeof __initial_auth_token !== 'undefined') {
                        await signInWithCustomToken(state.auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(state.auth);
                    }

                    // Listen for auth state changes to get userId
                    onAuthStateChanged(state.auth, (user) => {
                        if (user) {
                            state.userId = user.uid;
                            console.log("Firebase user ID:", state.userId);
                            loadWorkoutHistory(); // Load history after user is authenticated
                        } else {
                            // This branch means user signed out or initial anonymous sign-in failed (unlikely if initApp succeeded)
                            // If user explicitly signs out, userId will be null.
                            state.userId = crypto.randomUUID(); // Fallback for edge cases
                            console.log("User not authenticated, using random ID:", state.userId);
                            // Do not load history here if not authenticated, as it depends on user.uid
                        }
                    });
                } catch (error) {
                    console.error("Error during Firebase initialization or authentication:", error);
                    historyTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-red-600 text-center">Error setting up Firebase: ${error.message}. Cloud persistence will not be available.</td></tr>`;
                    state.userId = crypto.randomUUID(); // Fallback for local operations
                }
            } else {
                console.warn("Firebase config is missing projectId or is empty. Cloud persistence will not be available.");
                historyTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-yellow-600 text-center">Cloud persistence not available. Firebase project ID missing from configuration.</td></tr>`;
                state.userId = crypto.randomUUID(); // Ensure local operations still have a user ID
            }

            // Initial render calls, as Firebase init is async.
            renderCurrentSessionLifts();
            // Initial history display: set a placeholder, loadHistory will fill it or keep placeholder if Firebase not active.
            if (!state.db) { // If Firebase init failed, show immediate non-loading message for history
                historyTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 text-center">Cloud persistence not available. History cannot be loaded.</td></tr>`;
            } else { // Otherwise, Firebase is attempting to initialize, so show loading
                historyTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 text-center">Loading workout history...</td></tr>`;
            }

            // --- Utility Functions ---
            function updateRing(percent) {
                const offset = ringCircumference - (percent / 100) * ringCircumference;
                progressRing.style.strokeDashoffset = offset;
            }

            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.floor(seconds % 60);
                return `${minutes}m ${remainingSeconds}s`;
            }

            // --- Weight Test Logic ---
            function startTestTimer() {
                clearInterval(state.testTimerId);
                startTestBtn.disabled = true;
                saveWeightBtn.disabled = true;
                state.testSeconds = 10;
                testTimerDisplay.textContent = state.testSeconds;
                
                state.testTimerId = setInterval(() => {
                    state.testSeconds--;
                    testTimerDisplay.textContent = state.testSeconds;
                    if (state.testSeconds <= 0) {
                        clearInterval(state.testTimerId);
                        testTimerDisplay.textContent = "Test Complete!";
                        startTestBtn.disabled = false;
                        saveWeightBtn.disabled = false;
                    }
                }, 1000);
            }

            function saveWeight() {
                state.workoutGripType = gripTestTypeInput.value;
                state.workoutWeight = parseFloat(testWeightInput.value);
                workoutGripTypeInput.value = state.workoutGripType;
                workoutWeightInput.value = state.workoutWeight;
            }

            // --- Main Workout Logic ---
            function startWorkoutFlow() {
                // Hide setup, show engine
                workoutSetupDiv.classList.add('hidden');
                workoutEngineDiv.classList.remove('hidden');
                setActionsDiv.classList.add('hidden'); 
                cancelWorkoutBtn.classList.remove('hidden');
                upNextDisplay.classList.add('hidden');
                totalTimesDisplay.classList.add('hidden'); // Hide total times until workout complete

                // Update state from inputs
                state.workoutGripType = workoutGripTypeInput.value;
                state.workoutWeight = parseFloat(workoutWeightInput.value);
                state.maxSets = parseInt(workoutNumSetsInput.value);
                state.liftDuration = parseInt(workoutLiftDurationInput.value);

                // Reset for a new workout session
                state.currentSet = 1;
                state.currentLiftHandIndex = 0;
                state.currentSessionLifts = []; // Clear individual lifts from previous session
                state.totalLiftDuration = 0;
                state.totalRestDuration = 0;
                state.workoutStartTime = Date.now(); // Start tracking overall workout time

                renderCurrentSessionLifts(); // Clear the current session table

                state.currentPhase = 'lifting';
                runWorkoutPhase(); // Start the first lift
            }

            function runWorkoutPhase() {
                clearInterval(state.workoutTimerId);

                state.workoutHand = state.hands[state.currentLiftHandIndex]; // Update current hand in state

                // Update display based on current phase and hand
                currentSetDisplay.textContent = `Set ${state.currentSet} of ${state.maxSets}`;
                currentHandDisplay.textContent = `${state.workoutHand} Hand Lift`;
                setInfo.textContent = `Grip: ${state.workoutGripType} | Weight: ${state.workoutWeight} lbs/kg`;

                let totalPhaseDuration = 0;

                if (state.currentPhase === 'lifting') {
                    state.countdown = state.liftDuration;
                    timerStatus.textContent = "LIFT!";
                    timerStatus.classList.remove('text-green-600');
                    timerStatus.classList.add('text-red-600');
                    progressRing.classList.remove('text-green-500');
                    progressRing.classList.add('text-teal-500');
                    totalPhaseDuration = state.liftDuration;
                    progressRing.style.strokeDashoffset = ringCircumference; // Reset ring
                } else if (state.currentPhase === 'resting') {
                    state.countdown = state.restDuration;
                    timerStatus.textContent = "REST";
                    timerStatus.classList.remove('text-red-600');
                    timerStatus.classList.add('text-green-600');
                    progressRing.classList.remove('text-teal-500');
                    progressRing.classList.add('text-green-500');
                    totalPhaseDuration = state.restDuration;
                    progressRing.style.strokeDashoffset = ringCircumference; // Reset ring
                }
                
                updateUpNextDisplay(); // Update "Up Next" display

                state.workoutTimerId = setInterval(() => {
                    // Update total durations
                    if (state.currentPhase === 'lifting') {
                        state.totalLiftDuration++;
                    } else if (state.currentPhase === 'resting') {
                        state.totalRestDuration++;
                    }
                    
                    if (state.countdown < 0) {
                        handlePhaseEnd();
                    } else {
                        // Display time as minutes:seconds during rest, or just seconds during lift
                        if (state.currentPhase === 'resting') {
                            const minutes = Math.floor(state.countdown / 60);
                            const seconds = state.countdown % 60;
                            timerCountdown.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                        } else { // Lifting phase
                            timerCountdown.textContent = state.countdown;
                        }
                        updateRing((state.countdown / totalPhaseDuration) * 100);
                        state.countdown--;
                    }
                }, 1000);
            }

            function handlePhaseEnd() {
                clearInterval(state.workoutTimerId);

                if (state.currentPhase === 'lifting') {
                    logLiftResult(); // Log the lift
                    state.currentPhase = 'resting';
                    runWorkoutPhase(); // Start rest phase
                } else if (state.currentPhase === 'resting') {
                    if (state.currentLiftHandIndex === 0) { // Just finished rest after Right hand
                        state.currentLiftHandIndex = 1; // Prepare for Left hand
                        state.currentPhase = 'lifting';
                        runWorkoutPhase(); // Start Left hand lift
                    } else { // Just finished rest after Left hand
                        if (state.currentSet < state.maxSets) {
                            state.currentSet++; // Move to next set
                            state.currentLiftHandIndex = 0; // Reset to Right for next set
                            state.currentPhase = 'lifting';
                            runWorkoutPhase(); // Start next set (Right hand)
                        } else {
                            // Workout complete
                            showWorkoutComplete();
                        }
                    }
                }
            }

            function logLiftResult() {
                const now = new Date();
                const formattedDate = now.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                
                const newEntry = {
                    date: formattedDate,
                    gripType: state.workoutGripType,
                    hand: state.hands[state.currentLiftHandIndex], // Log the hand that just completed the lift
                    weight: state.workoutWeight,
                    setNumber: state.currentSet,
                    repDuration: state.liftDuration // This is the planned duration
                };
                state.currentSessionLifts.push(newEntry);
                renderCurrentSessionLifts();
            }

            function renderCurrentSessionLifts() {
                currentSessionTableBody.innerHTML = '';  
                if (state.currentSessionLifts.length === 0) {
                    currentSessionTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 text-center">No lifts logged in current session.</td>
                        </tr>
                    `;
                    return;
                }
                state.currentSessionLifts.forEach(result => {
                    const row = currentSessionTableBody.insertRow();
                    row.className = 'hover:bg-slate-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${result.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${result.gripType}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${result.hand}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${result.setNumber}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${result.repDuration}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${result.weight}</td>
                    `;
                });
            }

            function updateUpNextDisplay() {
                upNextDisplay.classList.remove('hidden');
                let nextText = '';

                if (state.currentPhase === 'lifting' && state.currentLiftHandIndex === 0) { // Currently lifting Right hand
                    nextText = `Rest (${formatTime(state.restDuration)}), then Set ${state.currentSet}: Left Hand`;
                } else if (state.currentPhase === 'lifting' && state.currentLiftHandIndex === 1) { // Currently lifting Left hand
                    if (state.currentSet < state.maxSets) {
                        nextText = `Rest (${formatTime(state.restDuration)}), then Set ${state.currentSet + 1}: Right Hand`;
                    } else {
                        nextText = "Workout will be complete!";
                    }
                } else if (state.currentPhase === 'resting') {
                     if (state.currentLiftHandIndex === 0) { // Just finished rest after Right hand, next is Left
                        nextText = `Set ${state.currentSet}: Left Hand`;
                    } else { // Just finished rest after Left hand, next is new Set or complete
                        if (state.currentSet < state.maxSets) {
                            nextText = `Set ${state.currentSet + 1}: Right Hand`;
                        } else {
                            nextText = "Workout will be complete!";
                        }
                    }
                }
                upNextText.textContent = nextText;
            }

            async function showWorkoutComplete() {
                clearInterval(state.workoutTimerId);
                state.currentPhase = 'complete';

                // Calculate total workout time
                state.totalWorkoutDuration = (Date.now() - state.workoutStartTime) / 1000;

                timerStatus.textContent = "Workout Complete!";
                timerCountdown.textContent = "üéâ";
                updateRing(100);
                currentHandDisplay.textContent = `All ${state.maxSets} Sets Completed!`;
                setInfo.textContent = ""; 
                upNextDisplay.classList.add('hidden');
                
                // Display total times
                totalWorkoutTimeSpan.textContent = formatTime(state.totalWorkoutDuration);
                totalLiftTimeSpan.textContent = formatTime(state.totalLiftDuration);
                totalRestTimeSpan.textContent = formatTime(state.totalRestDuration);
                totalTimesDisplay.classList.remove('hidden');

                setActionsDiv.classList.remove('hidden');
                cancelWorkoutBtn.classList.add('hidden');

                // Save workout summary to Firestore
                if (state.db && state.userId !== 'anonymous') { // Only attempt to save if Firebase is initialized and authenticated
                    try {
                        const workoutSummary = {
                            date: new Date().toISOString(), // ISO string for easy sorting/display
                            gripType: state.workoutGripType,
                            weight: state.workoutWeight,
                            liftDurationPerHold: state.liftDuration,
                            numSets: state.maxSets,
                            totalLiftDuration: state.totalLiftDuration,
                            totalRestDuration: state.totalRestDuration,
                            totalWorkoutDuration: state.totalWorkoutDuration,
                            userId: state.userId // Store userId for security rules
                        };
                        const workoutsCollectionRef = collection(state.db, `artifacts/${appId}/users/${state.userId}/max_weight_workout_summaries`);
                        await addDoc(workoutsCollectionRef, workoutSummary);
                        console.log("Workout summary saved successfully!");
                        loadWorkoutHistory(); // Refresh history after saving new workout
                    } catch (e) {
                        console.error("Error saving workout summary:", e);
                        // Inform the user about the saving error
                    }
                } else {
                    console.warn("Skipping workout summary save: Firebase not initialized or user not authenticated.");
                    // Optionally, inform the user on the UI that data could not be saved.
                }
            }

            function resetWorkoutForNewSession() {
                clearInterval(state.workoutTimerId);
                state.currentSet = 1;
                state.currentLiftHandIndex = 0;
                state.currentPhase = 'setup'; 
                state.currentSessionLifts = [];
                state.totalLiftDuration = 0;
                state.totalRestDuration = 0;
                state.workoutStartTime = null;

                workoutSetupDiv.classList.remove('hidden');
                workoutEngineDiv.classList.add('hidden');
                updateRing(0);
                timerStatus.textContent = "LIFT!"; 
                timerCountdown.textContent = state.liftDuration; 
                setActionsDiv.classList.add('hidden');
                cancelWorkoutBtn.classList.remove('hidden'); 
                totalTimesDisplay.classList.add('hidden'); // Hide total times

                renderCurrentSessionLifts(); // Clear current session table
                updateUpNextDisplay(); // Clear up next display
            }

            // --- Firestore Loading and Display of Workout History ---
            async function loadWorkoutHistory() {
                // Only load if Firebase is ready and user is authenticated with a proper UID
                if (!state.db || !state.userId || state.userId === 'anonymous') { 
                    console.warn("Firebase not ready to load history, or user is anonymous placeholder. Skipping history load.");
                    // If firebase was not initialized, the initial placeholder message already exists.
                    // Otherwise, set a specific message if it was initialized but auth is not resolved yet for the user.
                    if (state.db) {
                        historyTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 text-center">Waiting for user authentication to load history...</td></tr>`;
                    }
                    return;
                }
                
                historyTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 text-center">Loading workout history...</td></tr>`;

                try {
                    const workoutsCollectionRef = collection(state.db, `artifacts/${appId}/users/${state.userId}/max_weight_workout_summaries`);
                    // Note: orderBy is commented out as per instructions, but would typically be used for sorting by date
                    const q = query(workoutsCollectionRef); // , orderBy("date", "desc") 
                    const querySnapshot = await getDocs(q);
                    
                    state.workoutHistorySummaries = [];
                    querySnapshot.forEach((doc) => {
                        state.workoutHistorySummaries.push(doc.data());
                    });
                    
                    // Sort by date in descending order manually since orderBy is restricted
                    state.workoutHistorySummaries.sort((a, b) => new Date(b.date) - new Date(a.date));

                    renderWorkoutHistory();
                } catch (e) {
                    console.error("Error loading workout history:", e);
                    historyTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-red-600 text-center">Error loading history: ${e.message}.</td></tr>`;
                }
            }

            function renderWorkoutHistory() {
                historyTableBody.innerHTML = '';
                if (state.workoutHistorySummaries.length === 0) {
                    historyTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 text-center">No past workouts logged yet.</td>
                        </tr>
                    `;
                    return;
                }
                state.workoutHistorySummaries.forEach(summary => {
                    const row = historyTableBody.insertRow();
                    row.className = 'hover:bg-slate-50';
                    const workoutDate = new Date(summary.date);
                    const formattedDate = workoutDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${formattedDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${summary.gripType}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${summary.weight}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${summary.numSets}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${summary.liftDurationPerHold}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${formatTime(summary.totalWorkoutDuration)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${formatTime(summary.totalLiftDuration)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${formatTime(summary.totalRestDuration)}</td>
                    `;
                });
            }
            
            // Event Listeners
            startTestBtn.addEventListener('click', startTestTimer);
            saveWeightBtn.addEventListener('click', saveWeight);
            startWorkoutBtn.addEventListener('click', startWorkoutFlow);
            cancelWorkoutBtn.addEventListener('click', resetWorkoutForNewSession);
            startNewWorkoutBtn.addEventListener('click', resetWorkoutForNewSession);
        });
    </script>
</body>
</html>
